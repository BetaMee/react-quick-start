{"version":3,"sources":["../server/app.js"],"names":["app","use","static","resolve","__dirname","express","enable","json","urlencoded","extended","process","env","NODE_ENV","webpackconfig","require","compiler","noInfo","publicPath","output","stats","assets","colors","version","hash","timings","chunks","chunkModules","get","req","res","next","html","status","end","headersSent","err","Error","timedout","headers","upgrade","statusCode","console","error","stack","originalUrl","timeout","send","module","exports"],"mappings":";;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AAEA;AACA;;AAEA,IAAMA,MAAM,wBAAZ;;AAGAA,IAAIC,GAAJ,CAAQ,kBAAQC,MAAR,CAAe,eAAKC,OAAL,CAAaC,SAAb,EAAwB,UAAxB,CAAf,CAAR;;AAEA;AACAJ,IAAIC,GAAJ,CAAQ,8BAAQ,KAAR,CAAR;;AAEA;AACAD,IAAIC,GAAJ,CAAQ,qBAAGI,OAAH,EAAR;;AAEAL,IAAIM,MAAJ,CAAW,aAAX;AACA;AACA;;AAEAN,IAAIC,GAAJ,CAAQ,qBAAWM,IAAX,EAAR;AACAP,IAAIC,GAAJ,CAAQ,qBAAWO,UAAX,CAAsB,EAAEC,UAAU,KAAZ,EAAtB,CAAR;;AAEA;AACA,IAAIC,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C;AAAE;AAC5C,MAAMC,gBAAgBC,QAAQ,0BAAR,CAAtB;AACA,MAAMC,WAAW,uBAAQF,aAAR,CAAjB;AACAb,MAAIC,GAAJ,CAAQa,QAAQ,wBAAR,EAAkCC,QAAlC,EAA4C;AAClDC,YAAQ,IAD0C;AAElDC,gBAAYJ,cAAcK,MAAd,CAAqBD,UAFiB;AAGlDE,WAAO;AACLC,cAAQ,KADH;AAELC,cAAQ,IAFH;AAGLC,eAAS,KAHJ;AAILC,YAAM,KAJD;AAKLC,eAAS,KALJ;AAMLC,cAAQ,KANH;AAOLC,oBAAc;AAPT;AAH2C,GAA5C,CAAR;AAaA1B,MAAIC,GAAJ,CAAQa,QAAQ,wBAAR,EAAkCC,QAAlC,CAAR;AACD;;AAID;AACA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;AACA;;AAEAf,IAAI2B,GAAJ,CAAQ,GAAR,EAAa,UAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC/B,MAAMC,OAAO,4BAAiBrB,QAAQC,GAAR,CAAYC,QAA7B,CAAb;AACAiB,MAAIG,MAAJ,CAAW,GAAX,EAAgBC,GAAhB,CAAoBF,IAApB;AACD,CAHD;;AAOA/B,IAAIC,GAAJ,CAAQ,UAAC2B,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC1B;AACA,MAAI,CAACD,IAAIK,WAAT,EAAsB;AACpB,QAAIC,MAAM,IAAIC,KAAJ,CAAU,WAAV,CAAV;AACAD,QAAIH,MAAJ,GAAa,GAAb;AACAF,SAAKK,GAAL;AACD;AACF,CAPD;;AASA;AACAnC,IAAIC,GAAJ,CAAQ,UAACkC,GAAD,EAAMP,GAAN,EAAWC,GAAX,EAAgBC,IAAhB,EAAyB;AAC/B,MAAIF,IAAIS,QAAJ,IAAgBT,IAAIU,OAAJ,CAAYC,OAAZ,KAAwB,WAA5C,EAAyD;AACvD;AACA;AACD;;AAED,MAAIC,aAAaL,IAAIH,MAAJ,IAAc,GAA/B;AACA,MAAIQ,eAAe,GAAnB,EAAwB;AACtBC,YAAQC,KAAR,CAAcP,IAAIQ,KAAJ,IAAaR,GAA3B;AACD;AACD,MAAIP,IAAIS,QAAR,EAAkB;AAChBI,YAAQC,KAAR,CAAc,2DAAd,EAA2Ed,IAAIgB,WAA/E,EAA4FT,IAAIU,OAAhG;AACD;AACDhB,MAAIG,MAAJ,CAAWQ,UAAX;AACA;AACA,MAAIE,QAAQ,EAAZ;AACA,MAAI1C,IAAI2B,GAAJ,CAAQ,KAAR,MAAmB,aAAvB,EAAsC;AACpC;AACAe,YAAQP,GAAR;AACD;AACDN,MAAIiB,IAAJ,CAASX,GAAT;AACD,CArBD;;AAuBAY,OAAOC,OAAP,GAAiBhD,GAAjB","file":"app.js","sourcesContent":["import express from 'express';\r\nimport bodyParser from 'body-parser';\r\nimport timeout from 'connect-timeout';\r\nimport path from 'path';\r\nimport AV from 'leanengine';\r\nimport webpack from 'webpack';\r\n\r\nimport { RenderClientPage, RenderManagePage } from './view/view';\r\n\r\n// 加载云函数定义，你可以将云函数拆分到多个文件方便管理，但需要在主文件中加载它们\r\n// require('./cloud/cloud.js');\r\n\r\nconst app = express();\r\n\r\n\r\napp.use(express.static(path.resolve(__dirname, '../build')));\r\n\r\n// 设置默认超时时间\r\napp.use(timeout('15s'));\r\n\r\n// 加载云引擎中间件\r\napp.use(AV.express());\r\n\r\napp.enable('trust proxy');\r\n// 需要重定向到 HTTPS 可去除下一行的注释。\r\n// app.use(AV.Cloud.HttpsRedirect());\r\n\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.urlencoded({ extended: false }));\r\n\r\n// 热加载热替换在开发环境下的配置\r\nif (process.env.NODE_ENV === 'development') { // 开发模式下\r\n  const webpackconfig = require('../webpack.config.dev.js');\r\n  const compiler = webpack(webpackconfig);\r\n  app.use(require('webpack-dev-middleware')(compiler, {\r\n    noInfo: true,\r\n    publicPath: webpackconfig.output.publicPath,\r\n    stats: {\r\n      assets: false,\r\n      colors: true,\r\n      version: false,\r\n      hash: false,\r\n      timings: false,\r\n      chunks: false,\r\n      chunkModules: false,\r\n    },\r\n  }));\r\n  app.use(require('webpack-hot-middleware')(compiler));\r\n} \r\n\r\n\r\n\r\n// app.use('/apiclient', function(req, res, next) {\r\n//   res.send('client');\r\n// });\r\n\r\n// app.use('/apimanage', function(req, res, next) {\r\n//   res.send('manage');\r\n// });\r\n\r\n\r\n// app.get('/manage', function(req, res, next) {\r\n//   res.sendFile(path.resolve(__dirname, './manage.html'));\r\n// });\r\n\r\napp.get('*', (req, res, next) => {\r\n  const html = RenderClientPage(process.env.NODE_ENV);\r\n  res.status(200).end(html);\r\n});\r\n\r\n\r\n\r\napp.use((req, res, next) => {\r\n  // 如果任何一个路由都没有返回响应，则抛出一个 404 异常给后续的异常处理器\r\n  if (!res.headersSent) {\r\n    var err = new Error('Not Found');\r\n    err.status = 404;\r\n    next(err);\r\n  }\r\n});\r\n\r\n// error handlers\r\napp.use((err, req, res, next) => {\r\n  if (req.timedout && req.headers.upgrade === 'websocket') {\r\n    // 忽略 websocket 的超时\r\n    return;\r\n  }\r\n\r\n  var statusCode = err.status || 500;\r\n  if (statusCode === 500) {\r\n    console.error(err.stack || err);\r\n  }\r\n  if (req.timedout) {\r\n    console.error('请求超时: url=%s, timeout=%d, 请确认方法执行耗时很长，或没有正确的 response 回调。', req.originalUrl, err.timeout);\r\n  }\r\n  res.status(statusCode);\r\n  // 默认不输出异常详情\r\n  var error = {};\r\n  if (app.get('env') === 'development') {\r\n    // 如果是开发环境，则将异常堆栈输出到页面，方便开发调试\r\n    error = err;\r\n  }\r\n  res.send(err);\r\n});\r\n\r\nmodule.exports = app;\r\n"]}